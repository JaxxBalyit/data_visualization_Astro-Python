---
export interface Props {
  title: string;
  endpoint: string;
  x: string;
  y: string;
  xLabel: string;
  yLabel: string;
  color?: string;
  mode?: 'lines' | 'lines+markers' | 'markers';
}

const {
  title,
  endpoint,
  x,
  y,
  xLabel,
  yLabel,
  color = '#10b981',
  mode = 'lines+markers'
} = Astro.props;

const chartId = `chart-${Math.random().toString(36).substr(2, 9)}`;
---

<div class="bg-gray-800 rounded-xl p-5 shadow-xl border border-gray-700">
  <h4 class="text-lg font-semibold text-white mb-3">{title}</h4>
  <div id={chartId} class="h-72 w-full relative">
    <div class="absolute inset-0 flex items-center justify-center text-gray-400">
      Cargando datos...
    </div>
  </div>
</div>

<script define:vars={{ chartId, endpoint, x, y, xLabel, yLabel, color, title, mode }} type="module">
  const div = document.getElementById(chartId);
  const apiUrl = `https://mente-ecologica-api.onrender.com/api/${endpoint}`;

  console.log("Chart ID real:", chartId);      
  console.log("API URL real:", apiUrl);          

  fetch(apiUrl)
    .then(r => {
      if (!r.ok) throw new Error(`Error ${r.status}`);
      return r.json();
    })
    .then(data => {
      console.log("Datos recibidos:", data);

      div.innerHTML = ""; 

      const trace = {
        x: data.map(d => d[x]),
        y: data.map(d => d[y]),
        type: 'scatter',
        mode: mode,
        line: { color, width: 4 },
        marker: { size: 10 },
        name: title
      };

      const layout = {
        title: { text: title, font: { color: "#fff", size: 16 } },
        xaxis: { title: xLabel, color: "#ccc", gridcolor: "#444" },
        yaxis: { title: yLabel, color: "#ccc", gridcolor: "#444" },
        paper_bgcolor: "rgba(0,0,0,0)",
        plot_bgcolor: "rgba(0,0,0,0)",
        hovermode: "x unified"
      };

      Plotly.newPlot(div, [trace], layout, { responsive: true });
    })
    .catch(err => {
      div.innerHTML = `<p class="text-red-500">Error: ${err.message}</p>`;
      console.error(err);
    });
</script>